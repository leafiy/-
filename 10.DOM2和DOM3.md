##DOM2和DOM3

####元素大小

#####偏移量

- `offsetHeight` 元素在垂直方向上占用的空间大小，以像素计。包括元素的高度、（可见的）水平滚动条的高度、上边框高度和下边框高度
- `offsetWidth` 元素在水平方向上占用的空间大小，以像素计。包括元素的宽度、（可见的）垂直滚动条的宽度、左边框宽度- 右边框宽度
- `offsetLeft` 元素的左外边框至包含元素的左内边框之间的像素距离
- `offsetTop` 元素的上外边框至包含元素的上内边框之间的像素距离

```js
function getElLeft(el){
	var left = el.offsetLeft;
	var current = el.offsetParent;
	while(current !== null){
		left+= current.offsetLeft;
		current = current.offsetParent;
	}
	return left;
}

function getElTop(el){
	var top = el.offsetTop;
	var current = el.offsetParent;
	while(current !== null){
		top += current.offsetTop;
		current = current.offsetParent;
	}
	return top;
}

function getPos(el) {
    for (var lx=0, ly=0;
         el != null;
         lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
    return {x: lx,y: ly};
}
```

#####客户区大小

```js
var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
```

#####滚动大小

- `scrollHeight `在没有滚动条的情况下，元素内容的总高度
- `scrollWidth` 在没有滚动条的情况下，元素内容的总宽度
- `scrollLeft` 被隐藏在内容区域左侧的像素数。通过设置这个属性可以改变元素的滚动位置
- `scrollTop` 被隐藏在内容区域上方的像素数。通过设置这个属性可以改变元素的滚动位置
- 在确定文档的总高度时（包括基于视口的最小高度时），必须取得scrollWidth/clientWidth和scrollHeight/clientHeight中的最大值，才能保证在跨浏览器的环境下得到精确的结果

```js
var doc = document.documentElement
var docHeight = Math.max(doc.scrollHeight, doc.clientHeight)
var docWidth = Math.max(doc.scrollWidth, doc.clientWidth)

// 滚动到顶部
function scrollToTop(el) {
	if(el.scrollTop != 0){
		el.scrolltop = 0;
	}
}
```

#####元素大小

- `getBoundingClientRect()` 返回会一个矩形对象，left、top、right、bottom，给出了元素在页面中相对于视口的位置

```js
var rect = el.getBoundingClientRect();
{
  top: rect.top + document.body.scrollTop,
  left: rect.left + document.body.scrollLeft
}
```


###遍历 - 略

###范围

> “DOM2级遍历和范围”模块定义了“范围”接口。通过范围可以选择文档中的一个区域，而不必考虑节点的界限（选择在后台完成，对用户是不可见的）

####DOM中的范围

- DOM2级在Document类型中定义了 `createRange()` 方法，可以用来创建DOM范围

```js
var range = doucment.createRange();
```

- 每个范围由一个Range类型的实例表示
	- `startContainer` 包含范围起点的节点（选区中第一个节点的父节点）
	- `startOffset` 范围在startContainer中起点的偏移量
	- `endContainer` 包含范围终点的节点（选区中最后一个节点的父节点）
	- `endOffset` 范围在endContainer中终点的偏移量
	- `commonAncestorContainer` startContainer和endContainer共同的祖先节点在文档树中位置最深的那个

#####用DOM范围实现简单选择

- `selectNode()` 选择整个节点，包括子节点
- `selectNodeContents()` 选择节点的子节点

```html
<body>
    <p id="p1"><b>Hello</b> world!</p>
</body>
```

```js
var range1 = document.createRange(),
    range2 = document.createRange(),
    p1 = document.getElementById("p1");
range1.selectNode(p1);
range2.selectNodeContents(p1);

range1.startContainer; //document.body
range1.startOffset; //1 有个空格
range1.endContainer; //document.body
range1.endOffset; //2
range1.commonAncestorContainer; //document.body

range2.startContainer; //p1
range2.startOffset; //0
range2.endContainer; //p1
range2.endOffset; //2
range2.commonAncestorContainer; //p1
```

- 在调用 `selectNode()` 时，`startContainer` `endContainer` `commonAncestorContainer` 等都等于传入节点的父节点，也就是其中的 `document.body` 而 `startOffset` 属性等于给定节点在其父节点的 `childNodes` 集合中的索引。`endOffset` 等于 `startOffset` 加上1；
- 在调用 `selectNodeContents()` 时，`startContainer` `endContainer` `commonAncestorContainer` 等于传入的节点。而 `startOffset` 属性始终等于0 `endOffset` 等于子节点的数量 `node.childNodes.length`

#####更精细的选择

- 为了更精细的控制将哪些节点包含在范围中，还可以使用下列方法：
	- `setStartBefore(refNode)` 将范围的起点设置在refNode之前
	- `setStartAfter(refNode)` 将范围的起点设置在refNode之后
	- `setEndBefore(refNode)` 将范围的终点设置在refNode之前
	- `setEndAfter(refNode)` 将范围的终点设置在refNode之后

```html
<p id="p1">
    <b>Hello</b> world!
</p>
<div>
    <p>hello</p>
</div>
```

```js
var range1 = document.createRange(),
    range2 = document.createRange(),
    p1 = document.getElementById("p1");
range1.selectNode(p1);
range1.setStartAfter(p1);

range1.startContainer; //document.body
range1.startOffset; //2 有1个空格和一个p元素
range1.endContainer; //document.body
range1.endOffset; //2 选择了一个元素，所以是startOffset加1
range1.commonAncestorContainer; //document.body

range2.setStartAfter(p1); //结果与上面的相同
range2.startContainer; //document.body
range2.startOffset; //2
range2.endContainer; //document.body
range2.endOffset; //2
range2.commonAncestorContainer; //document.body
```

#####用DOM范围实现更加复杂的选择

- `setStart()` 接受两个参数：一个参照节点和一个偏移量值，参照节点会变成 `startContainer`，偏移值则会变成 `startOffset`
- `setEnd()` 接受两个参数：一个参照节点和一个偏移量值，参照节点会变成 `endContainer`，偏移值会变成 `endOffset`

```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p1 = document.getElementById("p1"),
    helloNode = p1.firstChild.firstChild,
    worldNode = p1.lastChild;
var range = document.createRange();
range.setStart(helloNode, 2);
range.setEnd(worldNode, 3);
// 这样就完成了对“llo wo”的选择
```

#####操作DOM范围中的内容

- `deleteContents()` 删除范围所包含的内容

```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p1 = document.getElementById("p1");
var hello = p1.firstChild.firstChild;
var world = p1.lastChild;
var range = document.createRange();

range.setStart(hello, 1);
range.setEnd(world, 2);

range.toString(); //ello w
p1.outerHTML; //<p id="p1"><b>Hello</b> world!</p>

range.deleteContents(); //刪除範圍內的內容
p1.outerHTML; //<p id="p1"><b>H</b>orld!</p>
```

```html
<ul id="list">
    <li>this is a list No.1</li>
    <li>this is a list No.2</li>
    <li>this is a list No.3</li>
    <li>this is a list No.4</li>
    <li>this is a list No.5</li>
</ul>
```

```js
var list = document.getElementById("list");
var starting = list.getElementsByTagName("li")[1];
var ending = list.getElementsByTagName("li")[3];
var range = document.createRange();
range.setStart(starting, 0);
range.setEnd(ending, 0);
range.toString();
list.outerHTML;
range.deleteContents();
list.outerHTML;
```

- `extractContents()` 移除范围所包含的内容并返回文档片段

```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p1 = document.querySelector("#p1");
var helloNode = p1.firstChild.firstChild,
    worldNode = p1.lastChild;
var range = document.createRange();
range.setStart(helloNode, 2);
range.setEnd(worldNode, 3);
var fragment = range.extractContents();
p1.parentNode.insertBefore(fragment, p1);
```

```html
<ul id="list">
    <li>this is a list No.1</li>
    <li>this is a list No.2</li>
    <li>this is a list No.3</li>
    <li>this is a list No.4</li>
    <li>this is a list No.5</li>
</ul>
```

```js
var list = document.getElementById("list");
var range = document.createRange();

var starting = list.getElementsByTagName("li")[1];
var ending = list.getElementsByTagName("li")[4];

range.selectNode(list);
range.setStartBefore(starting);
range.setEndBefore(ending);

var fragment = range.extractContents();
document.body.appendChild(fragment);

console.log(document.body.innerHTML);

// <li>thi is a list No.2</li>
// <li>thi is a list No.3</li>
// <li>thi is a list No.4</li>

console.log(list.innerHTML);

// <li>thi is a list No.1</li>
// <li>thi is a list No.5</li>
```

- `cloneContents()` 创建范围对象的一个副本

```js
var list = document.getElementById("list");
var range = document.createRange();

var starting = list.getElementsByTagName("li")[1];
var ending = list.getElementsByTagName("li")[4];

range.selectNode(list);
range.setStartBefore(starting);
range.setEndBefore(ending);

var fragment = range.cloneContents();
document.body.appendChild(fragment);

console.log(document.body.innerHTML);

// <li>thi is a list No.2</li>
// <li>thi is a list No.3</li>
// <li>thi is a list No.4</li>

console.log(list.innerHTML);

// <li>thi is a list No.1</li>
// <li>thi is a list No.2</li>
// <li>thi is a list No.3</li>
// <li>thi is a list No.4</li>
// <li>thi is a list No.5</li>
```

#####插入DOM范围中的内容

- `insertNode()` 向范围选区的开始处插入一个节点(范围内部插入内容)

```html
<ul id="list">
    <li>thi is a list No.1</li>
    <li>thi is a list No.2</li>
    <li>thi is a list No.3</li>
    <li>thi is a list No.4</li>
    <li>thi is a list No.5</li>
</ul>
```

```js
var list = document.getElementById("list");
var range = document.createRange();

var starting = list.getElementsByTagName("li")[1];
var ending = list.getElementsByTagName("li")[4];

range.selectNode(list);
range.setStartBefore(starting);
range.setEndBefore(ending);

var newLi = document.createElement("li");
newLi.appendChild(document.createTextNode("data"));
range.insertNode(newLi);

console.log(list.innerHTML);
// <li>thi is a list No.1</li>
// <li>data</li><li>thi is a list No.2</li>
// <li>thi is a list No.3</li>
// <li>thi is a list No.4</li>
// <li>thi is a list No.5</li>
```

```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p = document.getElementById("p1");
var range = document.createRange();
var starting = p.firstChild.firstChild;
var ending = p.lastChild;

range.setStart(starting, 5);
range.setEnd(ending, 0);

var span = document.createElement("span");
span.appendChild(document.createTextNode(" there in this"));

range.insertNode(span);

console.log(p1.innerText); //Hello there in this world!
console.log(p1.innerHTML); //<b>Hello<span> there in this</span></b> world!
```

- `surroundContents()` 向范围选区周围插入一个节点(围绕范围插入内容)，通常与`selectNode()` 配合，因为范围必须包含整个DOM选区，不能仅仅包含选中的DOM节点。

```html
<p id="p1"><b>Hello</b> world!</p>
```

```
var p = document.getElementById("p1");
var range = document.createRange();

range.selectNode(p.firstChild);

var span = document.createElement("span");
span.style.border = "1px solid orange";
span.style.borderRadius = "3px";

range.surroundContents(span);

console.log(p1.innerHTML); //<span style="border: 1px solid orange; border-radius: 3px;"><b>Hello</b></span> world!
```

- 为了插入 `span` 标签，范围必须包含整个DOM选区，所以推荐使用 `selectNode()` 配合。

#####折叠DOM范围

- `collapse()` 方法，折叠就是指范围中未选择文档的任何部分。该函数接收一个布尔参数。
	- true表示折叠到范围的起点
	- false表示折叠到范围的终点。

```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p = document.getElementById("p1");
var range = document.createRange();

range.selectNode(p);
range.collapse(true);
console.log(range.collapsed); //True
```

```html
<ul id="list">
    <li>thi is a list No.1</li>
    <li>thi is a list No.2</li>
    <li>thi is a list No.3</li>
    <li>thi is a list No.4</li><li>thi is a list No.5</li>
</ul>
```

```js
var list = document.querySelector("#list");
var range = document.createRange();
range.setStartAfter(list.getElementsByTagName("li")[1]);
range.setEndBefore(list.getElementsByTagName("li")[2]);
console.log(range.collapsed); //False 因为还有一个空白节点在这里

var range2 = document.createRange();
range2.setStartAfter(list.getElementsByTagName("li")[3]);
range2.setEndBefore(list.getElementsByTagName("li")[4]);
console.log(range2.collapsed); //True 因为范围没有选中任何部分
```

#####比较DOM范围

- `comopareBoundaryPoints()` 比较这些范围是否有公共的边界。接收两个参数：表示比较方式的常量值和要比较的范围
	- `Range.START_TO_START` 比较两个 Range 节点的开始点
	- `Range.END_TO_END` 比较两个 Range 节点的结束点
	- `Range.START_TO_END` 用 sourceRange 的开始点与当前范围的结束点比较
	- `Range.END_TO_START` 用 sourceRange 的结束点与当前范围的开始点比较

> 常量 Range.START_TO_END 指定与当前范围的 end 点和 sourceRange 的 start 点进行比较

> 常量 Range.END_TO_START 指定比较当前范围的 start 点和指定范围的 end 点

> 如果第一个范围中的点位于第二个范围中的点之前，返回-1；如果相等返回0；如果第一个范围中的点位于第二个范围中的点之后，返回1


```html
<p id="p1"><b>Hello</b> world!</p>
```

```js
var p = document.getElementById("p1");
var range1 = document.createRange();
var range2 = document.createRange();

range1.selectNodeContents(p);
range2.selectNodeContents(p);
range2.setEndBefore(p.lastChild);

console.log(range1.toString()); //Hello world!
console.log(range2.toString()); //Hello

console.log(range1.compareBoundaryPoints(Range.START_TO_START, range2)); //0
console.log(range1.compareBoundaryPoints(Range.END_TO_END, range2)); //1
```

```html
<ul id="list">
    <li>thi is a list No.1</li>
    <li>thi is a list No.2</li>
    <li>thi is a list No.3</li>
    <li>thi is a list No.4</li><li>thi is a list No.5</li>
</ul>
```

```js
var list = document.querySelector("#list");
var range1 = document.createRange();
var range2 = document.createRange();

range1.selectNodeContents(list);
range1.setStartAfter(list.firstChild.nextSibling);
range1.setEndBefore(list.lastChild.previousSibling);

range2.selectNodeContents(list);

console.log(range1.compareBoundaryPoints(Range.START_TO_START, range2)); //1
console.log(range1.compareBoundaryPoints(Range.END_TO_END, range2)); //-1
console.log(range1.compareBoundaryPoints(Range.START_TO_END, range2)); //1 注意这里是range1的END与range2的start对比；
console.log(range1.compareBoundaryPoints(Range.END_TO_START, range2)); //-1 注意这里是range1的START与range2的END对比；
```

#####复制DOM范围

- `cloneRange()` 方法复制范围

```js
var newRange = range.cloneRange();
```

- 清理DOM范围，`detach()` 方法清理范围

```js
range.detach();
range = null;
```