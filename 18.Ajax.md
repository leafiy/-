##Ajax

###XMLHttpRequest对象

```js
//新建xhr对象
var xhr = new XMLHttpRequest();
```

####XHR用法

- `open()` 三个参数：发送请求的类型、请求的URL、是否异步发送请求，不会发送真正的发送请求，而是启动一个请求以备发送
- `send()` 发送特定的请求
- 响应的数据会自动填充XHR对象的属性
	- `responseText` 作为响应主体被返回的文本
	- `responseXML` 如果响应的内容类型是"text/xml"或"application/xml"，这个属性中将保存包含着响应数据的XML DOM文档
	- `status` 响应的HTTP状态
	- `statusText` HTTP状态的说明

```js
xhr.open('get', 'url' ,false);
xhr.send(null);
if((xhr.status >=200 && xhr.status<300) || xhr.status == 304){
	alert (xhr.responseText);
}else{
	// unsuccessful
}
```

> 只能向同一个域中使用相同端口和协议的URL发送请求。如果URL与启动请求的页面有任何差别，都会引发安全错误

- 异步发送请求，可以检测XHR对象的 `readystate` 属性，表示响应过程的当前活动阶段
	- `0` 未初始化。尚未调用open()方法
	- `1` 启动。已经调用open()方法，但尚未调用send()方法
	- `2` 发送。已经调用send()方法，但尚未接收到响应
	- `3` 接收。已经接收到部分响应数据
	- `4` 完成。已经接收到全部响应数据，而且已经可以在客户端使用了
-  `readystate` 属性变换，会触发一个 `readystatechange` 事件，没有作用域不要使用 `this`

```js
xhr.onreadystatechange = function(){
	if(xhr.readystate == 4){
		if((xhr.status >=200 && xhr.status<300) || xhr.status == 304){
			alert (xhr.responseText);
		}else{
			// unsuccessful
		}
	}
}
```

- `abort()` 会使XHR对象停止触发事件，也不再允许访问任何与响应相关的对象属性

####HTTP头部信息

- 在发送XHR请求时，还会发送下列头部信息
	- `Accept` 浏览器能够处理的内容类型
	- `Accept-Charset` 浏览器能够显示的字符集
	- `Accept-Encoding` 浏览器能够处理的压缩编码
	- `Accept-Language` 浏览器当前设置的语言。
	- `Connection` 浏览器与服务器之间连接的类型
	- `Cookie` 当前页面设置的任何Cookie
	- `Host` 发出请求的页面所在的域
	- `Referer` 发出请求的页面的URI（这个英文单词的正确拼法应该是referrer）
	- `User-Agent` 浏览器的用户代理字符串
- `setRequestHeader()` 方法可以设置自定义的请求头部信息。两个参数：头部字段的名称和头部字段的值。
- 要成功发送请求头部信息，必须在调用 `open()` 方法之后且调用 `send()`方法之前调用 `setRequestHeader()`
- `getResponseHeader()` 方法并传入头部字段名称，可以取得相应的响应头部信息
- `getAllResponseHeaders()` 方法则可以取得一个包含所有头部信息的长字符串

```js
xhr.setRequestHeader('Myheader','myvalue');
```

####GET请求

- 常用于向服务器查询信息
- 查询字符串中每个参数的名称和值都必须使用 `encodeURIComponent()` 进行编码，然后才能放到URL的末尾；而且所有名-值对儿都必须由和号（&）分隔

```js
function addURLParam(url, name, value){
	url += (url.indexOf('?') == -1 ? '?' : '&');
	url += encodeURIComponent(name) + '=' + encodeURIComponent(value);
	return url;
}
```

####POST请求

- 通常用于向服务器发送应该被保存的数据

####FormData

- `FormData` 为序列化表单以及创建与表单格式相同的数据（用于通过XHR传输）提供了便利
- `append()` 接收键值两个参数，也可以直接传入表单元素 `new FormData(document.forms[0])`

####超时设定

- `xhr.timeout = 1000` `xhr.ontimeout()`

```js
xhr.onreadystatechange = function(){
	if(xhr.readystate == 4){
		try{
			if((xhr.status >=200 && xhr.status<300) || xhr.status == 304){
				alert (xhr.responseText);
			}else{
				// unsuccessful
			}
		}catch(ex){
			// 假设由 ontimeout处理
		}
	}
}
```

###进度事件

- `loadstart` 在接收到响应数据的第一个字节时触发
- `progress` 在接收响应期间持续不断地触发
- `error` 在请求发生错误时触发
- `abort` 在因为调用abort()方法而终止连接时触发
- `load` 在接收到完整的响应数据时触发
- `loadend` 在通信完成或者触发error、abort或load事件后触发

####load事件

- 响应接收完毕后将触发 `load` 事件，因此也就没有必要去检查 `readyState` 属性了
- `onload` 事件处理程序会接收到一个 `event` 对象，其 `target` 属性就指向 `XHR` 对象实例，因而可以访问到 `XHR`对象的所有方法和属性
- 只要浏览器接收到服务器的响应，不管其状态如何，都会触发 `load` 事件，必须要检查 `status` 属性，才能确定数据是否真的已经可用

```js
xhr.onload = function(){
	if((xhr.status >=200 && xhr.status<300) || xhr.status == 304){
		alert (xhr.responseText);
	}else{
		// unsuccessful
	}
}
```

####progress事件

- `progress` 事件会在浏览器接收新数据期间周期性地触发
- `onprogress` 事件处理程序会接收到一个 `event` 对象，其 `target` 属性是 `XHR` 对象，但包含着三个额外的属性：
	- `lengthComputable` 表示进度信息是否可用的布尔值
	- `position` 表示已经接收的字节数
	- `totalSize` 表示根据Content-Length响应头部确定的预期字节数

```js
xhr.onprogress = function(event){
	if(event.lengthComputable){
		(event.position / event.totalSize) + '%'
	}
}
```

###跨资源共享

- 使用 `get` 或 `post` 发送请求时，附带一个 `Origin` 头部，包含请求页面的信息（协议、域名、端口），如果 `Origin` 与服务器返回的 `Access-Control-Allow-Origin` 不符，浏览器会驳回请求

###Web sockets

> 在JavaScript中创建了Web Socket之后，会有一个HTTP请求发送到浏览器以发起连接。在取得服务器响应后，建立的连接会使用HTTP升级从HTTP协议交换为Web Socket协议

#####Web Sockets API

- 同源策略对web sockets不适用，传入绝对 URL
	- `WebSocket.OPENING (0)` 正在建立连接。
	- `WebSocket.OPEN (1)` 已经建立连接。
	- `WebSocket.CLOSING (2)` 正在关闭连接。
	- `WebSocket.CLOSE (3)` 已经关闭连接

#####发送和接收数据

- web sockets只能发送纯文本数据，复杂数据必须序列化
- 向客户端发送数据时，会触发 `message` 事件，数据保存在 `event.data` 中

```js
var socket = new WebSocket('ws://google.com');
socket.send('hello');

socket.onmessage = function(event){
	var data = event.data;
}
```

#####其他事件

- `open` 成功建立连接时触发
- `error` 发生错误时触发，连接不能连续
- `close` 关闭连接时触发，`event` 包含额外信息
	- `wasClean` 布尔值，表示是否已经明确的关闭
	- `code` 服务器返回的状态码
	- `reason` 字符串，包含服务器发回的消息